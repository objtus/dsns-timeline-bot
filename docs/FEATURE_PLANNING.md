# 新機能追加・拡張計画（2025-07-XX）

## 1. 目的
- ユーザー体験向上・検索性強化・データ活用促進のため、**カテゴリの複合フィルタリング**を中心とした新機能を段階的に追加する。
- 元のHTMLのカテゴリ設計思想（複合フィルタリング重視）を反映し、単純な単一カテゴリ検索ではなく、複数のカテゴリを組み合わせた高度な検索機能を実現する。
- 実装・運用・ドキュメント・ヘルプの全体整合性を重視。

## 2. 元のHTMLカテゴリ設計の理解

### 2.1 主要カテゴリ一覧
元のHTMLでは以下の主要カテゴリが複合的に使用されている：
- **d-sns (d)**: 分散SNS関連
- **sns**: ソーシャルネットワーク
- **web**: Web技術
- **network**: ネットワーク技術
- **web3**: Web3技術
- **hacker**: ハッカー文化・セキュリティ
- **tech**: 技術全般
- **culture**: 文化・コミュニティ
- **law**: 法律・規制
- **BBS**: 掲示板システム
- **site**: サイト・サービス
- **P2P**: P2P技術
- **crypto**: 暗号技術・暗号通貨
- **book**: 書籍・文献
- **incident**: 事件・事故
- **metaverse**: メタバース
- **mentalculture**: メンタル文化
- **meme**: ミーム・文化現象
- **pol**: 政治
- **art**: アート
- **flame**: 炎上・論争
- **tool**: ツール
- **etc**: その他

### 2.2 複合フィルタリングの重要性
- カテゴリは単にフィルタリングするのではなく、**複合的にフィルタリングする用途**でイベントに与えられている
- 例：`d-sns + tech + incident` で分散SNSの技術的事件を抽出
- 例：`web3 + crypto + law` でWeb3暗号技術の法的問題を抽出

## 3. コマンドフォーマット設計

### 3.1 カテゴリプレフィックス方式（採用決定）
**理由**: 明示的な識別、シンプルな記号、URL誘導対応、拡張性を兼ね備える

#### **基本フォーマット**
```
カテゴリ dsns+tech
カテゴリ dsns+tech-meme
検索 SNS カテゴリ dsns+tech
2000年代 カテゴリ web+tech
```

#### **記号ルール**
- **`+`**: カテゴリの追加（AND条件）
- **`-`**: カテゴリの除外（NOT条件）
- **`カテゴリ`**: 明示的なカテゴリ識別プレフィックス

#### **カテゴリ名の正規化**
```
d-sns → dsns（ハイフン除去）
web3 → web3（そのまま）
web → web（そのまま）
```

### 3.2 具体的なコマンド例
```
# 基本カテゴリ検索
カテゴリ dsns+tech
カテゴリ web+crypto
カテゴリ hacker+culture

# 除外条件
カテゴリ dsns+tech-meme
カテゴリ web+crypto-law

# 複合検索
検索 SNS カテゴリ dsns+tech
検索 暗号 カテゴリ crypto-law

# 年代＋カテゴリ
2000年代 カテゴリ web+tech
1990年代 カテゴリ dsns-incident

# カテゴリ一覧・統計
カテゴリ一覧
カテゴリ 統計
```

## 4. URL誘導機能

### 4.1 年表サイトのパラメータ対応
年表サイト（https://yuinoid.neocities.org/txt/my_dsns_timeline）の高度な検索機能との連携

#### **対応パラメータ**
- **`search`**: 検索キーワード
- **`class`**: 単一カテゴリフィルタリング
- **`checkboxes`**: 複数カテゴリフィルタリング（カンマ区切り）

#### **URL生成例**
```
カテゴリ dsns+tech
→ https://yuinoid.neocities.org/txt/my_dsns_timeline?checkboxes=dsns%2Ctech

検索 SNS カテゴリ dsns+tech
→ https://yuinoid.neocities.org/txt/my_dsns_timeline?search=SNS&checkboxes=dsns%2Ctech

カテゴリ web
→ https://yuinoid.neocities.org/txt/my_dsns_timeline?class=web
```

#### **除外条件の制限**
- **制限**: 年表サイトでは除外検索（NOT条件）ができない
- **対応策**: 除外条件がある場合は「除外条件あり」と明記
- **代替案**: 除外条件を別途表示し、手動で年表サイトで確認を促す

## 5. 追加機能案と優先度（複合フィルタリング重視）

### 🥇 最優先（即時着手可能）
#### 5.1 カテゴリ複合フィルタリング
- **複数カテゴリ指定**: `カテゴリ dsns+tech` でdsnsかつtechカテゴリのイベント
- **カテゴリ除外**: `カテゴリ dsns+tech-meme` でdsns・techだがmeme以外のイベント
- **カテゴリ一覧表示**: `カテゴリ一覧` で利用可能なカテゴリ一覧を表示

#### 5.2 複合検索（キーワード＋複数カテゴリ）
- **基本複合検索**: `検索 SNS カテゴリ dsns+tech` でSNSキーワードかつdsns・techカテゴリ
- **除外条件付き検索**: `検索 暗号 カテゴリ crypto-law` で暗号キーワードかつcryptoだがlaw以外

### 🥈 高優先度
#### 5.3 期間指定＋複合フィルタリング
- **年代＋カテゴリ**: `2000年代 カテゴリ web+tech` で2000年代のweb・techカテゴリ
- **年範囲＋複合条件**: `1995-2005 カテゴリ dsns-incident` で1995-2005年のdsnsだがincident以外

#### 5.4 カテゴリ統計・可視化
- **カテゴリ分布**: `カテゴリ統計` で年代別・年別のカテゴリ分布を表示
- **複合カテゴリ分析**: `カテゴリ分析 dsns` でdsnsと組み合わせられるカテゴリの統計

## 6. 影響範囲・考慮点（複合フィルタリング対応）

### 6.1 データベース設計
- **既存構造**: `categories`カラムはスペース区切りで複数カテゴリを保存済み
- **検索最適化**: 複合カテゴリ検索のためのインデックス追加を検討
- **正規化**: カテゴリ名の正規化（大文字小文字、ハイフン等）

### 6.2 コマンド解析の拡張
- **カテゴリプレフィックスパーサ**: `カテゴリ dsns+tech,web` の解析
- **除外条件パーサ**: `カテゴリ dsns+tech-meme` の解析
- **複合条件パーサ**: `検索 キーワード カテゴリ dsns+tech-incident` の解析

### 6.3 ハンドラー拡張
- **SearchHandler**: 複合カテゴリ条件の対応
- **DecadeHandler**: 年代別＋カテゴリ複合条件の対応
- **新規CategoryHandler**: カテゴリ専用機能の実装

## 7. 実装計画（複合フィルタリング重視）

### Phase 1: カテゴリ複合フィルタリング基盤
- [x] `database.py`に複合カテゴリ検索メソッド追加
  - `get_events_by_categories(categories: List[str], exclude_categories: List[str] = None)`
  - `get_category_statistics()`
- [x] `command_router.py`でカテゴリプレフィックスコマンド解析追加
  - `カテゴリ dsns+tech` パターン
  - `カテゴリ dsns+tech-meme` 除外パターン
- [x] 新規`CategoryHandler`の実装
- [x] URL誘導機能の実装
- [x] ヘルプ・テスト・ドキュメント反映

### Phase 2: 複合検索機能（完了）
- [x] `search_handler.py`で複合カテゴリ条件対応
- [x] `検索 キーワード カテゴリ dsns+tech-incident` パターン対応
- [x] 検索結果のカテゴリ別集計機能
- [x] 除外条件がある場合のURL誘導改善
- [x] テスト・ヘルプ反映
- [x] **エラーハンドリングテストで「存在しないカテゴリ」や「空カテゴリリスト」検索時に0件にならない問題を修正**
    - database.pyの`get_events_by_categories`で空リスト時に全件返してしまう設計ミスを修正
    - 空のカテゴリ・除外リスト時は0件返すように修正し、再テストで全て正常完了

### Phase 3: 年代別＋カテゴリ複合機能（完了）
- [x] `decade_handler.py`で年代別＋カテゴリ複合条件対応
- [x] `2000年代 カテゴリ web+tech` パターン対応
- [x] 年代別カテゴリ分布の可視化（統計・代表・概要すべてでカテゴリ複合対応）
- [x] テスト・ヘルプ反映
- [x] **統合テストで全てのケースが成功し、警告も解消**
    - 除外カテゴリの複数指定や複雑な条件も正しく解析・反映
    - 存在しないカテゴリや概要のカテゴリフィルタ表示も期待通り
    - 年代別URL付加処理の警告も解消

### Phase 4: カテゴリ統計・分析機能（完了）
- [x] カテゴリ統計表示機能
- [x] 複合カテゴリ分析機能
- [x] カテゴリ関連性分析機能
- [x] テスト・ヘルプ反映

### Phase 5: フィードバック・ドキュメント反映（完了）
- [x] `README.md`/`docs/PROJECT_MAP.md`/ヘルプメッセージの更新
- [x] 複合フィルタリングの詳細説明追加
- [x] カテゴリ統計・分析機能のドキュメント反映
- [x] ユーザーからのフィードバック反映

## 8. ヘルプコマンド拡張案（複合フィルタリング重視）

### 8.1 複合カテゴリフィルタの使い方
- `カテゴリ dsns+tech` → dsnsかつtechカテゴリのイベント一覧
- `カテゴリ dsns+tech-meme` → dsns・techだがmeme以外のカテゴリのイベント
- `カテゴリ一覧` → 利用可能なカテゴリ一覧を表示
- `検索 SNS カテゴリ dsns+tech-incident` → SNSキーワードかつdsns・techだがincident以外
- `2000年代 カテゴリ web+tech` → 2000年代のweb・techカテゴリのイベント

### 8.2 ヘルプメッセージ例（追記案）
```
🗂️ **カテゴリ複合フィルタ**
- 「カテゴリ dsns+tech」→ dsnsかつtechカテゴリのイベント一覧
- 「カテゴリ dsns+tech-meme」→ dsns・techだがmeme以外のカテゴリのイベント
- 「カテゴリ一覧」→ 利用可能なカテゴリ一覧を表示
- 「検索 SNS カテゴリ dsns+tech-incident」→ 複合条件での検索
- 「2000年代 カテゴリ web+tech」→ 年代＋カテゴリの複合条件

📊 **カテゴリ統計・分析**
- 「カテゴリ統計」→ 年代別・年別のカテゴリ分布
- 「カテゴリ分析 dsns」→ dsnsと組み合わせられるカテゴリの統計

🔗 **年表サイト連携**
- 検索結果には年表サイトへの直接リンクが含まれます
- 除外条件がある場合は手動で年表サイトで確認してください
```

## 9. 主要カテゴリの説明（ヘルプ用）
```
🔍 **主要カテゴリ説明**
- dsns: 分散SNS関連（d-snsの正規化）
- sns: ソーシャルネットワーク
- web: Web技術
- network: ネットワーク技術
- web3: Web3技術
- hacker: ハッカー文化・セキュリティ
- tech: 技術全般
- culture: 文化・コミュニティ
- law: 法律・規制
- BBS: 掲示板システム
- site: サイト・サービス
- P2P: P2P技術
- crypto: 暗号技術・暗号通貨
- book: 書籍・文献
- incident: 事件・事故
- metaverse: メタバース
- meme: ミーム・文化現象
- pol: 政治
- art: アート
- flame: 炎上・論争
- tool: ツール
```

## 10. README/PROJECT_MAP反映計画
- [ ] 新機能追加時は`README.md`/`docs/PROJECT_MAP.md`の「機能」「コマンド」「データ構造」等に必ず反映
- [ ] 複合フィルタリングの詳細説明・コマンド例・カテゴリ例を追記
- [ ] 実装後はヘルプコマンドの出力例も記載
- [ ] カテゴリ設計思想（複合フィルタリング重視）の説明を追加
- [ ] URL誘導機能の説明を追加

## 11. リスク・注意点（複合フィルタリング対応）
- **パフォーマンス**: 複合条件の組み合わせ増加による検索速度低下に注意
- **カテゴリ正規化**: 大文字小文字・ハイフン等の表記揺れの統一
- **ユーザビリティ**: 複雑な複合条件の入力方法の工夫（サジェスト・補完機能等）
- **カテゴリ関連性**: カテゴリ間の関連性・依存関係の考慮
- **URL誘導制限**: 除外条件がある場合の年表サイト連携の制限

## 12. 技術的考慮事項
- **SQLクエリ最適化**: 複合カテゴリ検索のための効率的なクエリ設計
- **インデックス戦略**: カテゴリ検索のための適切なインデックス設定
- **キャッシュ戦略**: 頻繁に使用されるカテゴリ組み合わせのキャッシュ
- **拡張性**: 新しいカテゴリの追加に対応できる設計
- **URL生成**: 年表サイトのパラメータ形式との正確な対応

---

> 本計画は元のHTMLのカテゴリ設計思想（複合フィルタリング重視）を反映し、カテゴリプレフィックス方式による明示的な識別とURL誘導機能を重視した実装を目指します。 

## 🚦 進捗・現状（2025-07-XX時点）

### フェーズ4: カテゴリ統計・分析機能の現状

- **カテゴリ統計・分析機能の実装が完了**
    - コマンド例: `カテゴリ統計`、`カテゴリ分析 dsns`、`カテゴリ分析 dsns+tech` など
    - 年代別・年別のカテゴリ分布表示
    - 指定カテゴリと共起するカテゴリの頻度分析
    - 複合カテゴリ条件での関連性分析
- **包括的なテストを作成・実行し、全てのテストが成功**
    - テストケース: カテゴリ統計、カテゴリ分析、複合条件、存在しないカテゴリなど
    - 単一カテゴリ、複合カテゴリ、除外条件も正しく動作
    - テスト成功率100%、警告・エラーなし
- **ヘルプ・ドキュメント反映も完了**
    - ヘルプメッセージにカテゴリ機能を追加
    - README.mdにカテゴリ機能の詳細説明を追加
    - PROJECT_MAP.mdに実装状況を反映
- **全フェーズの実装が完了し、プロジェクトが完成**

### フェーズ3: 年代＋カテゴリ複合機能の現状

- **年代別＋カテゴリ複合機能（統計・代表・概要）の実装が完了**
    - コマンド例: `2000年代 カテゴリ web+tech`、`1990年代 カテゴリ dsns-incident` など
    - 除外カテゴリの複数指定や複雑な条件も正しく解析・反映
    - 存在しないカテゴリや概要のカテゴリフィルタ表示も期待通り
    - 年代別URL付加処理の警告も解消
- **包括的な統合テストを作成・実行し、全てのテストが成功**
    - テストケース: 年代＋カテゴリ複合、除外条件、存在しないカテゴリ、概要フィルタ表示など
    - 除外カテゴリの複数指定や複雑な条件も正しく動作
    - テスト成功率100%、警告・エラーなし

---

## 進捗メモ
- **全フェーズの実装が完了**
  - フェーズ1-2: カテゴリ複合フィルタ機能 ✅
  - フェーズ3: 年代＋カテゴリ複合機能 ✅
  - フェーズ4: カテゴリ統計・分析機能 ✅
  - フェーズ5: フィードバック・ドキュメント反映 ✅
- **全ての機能が安定動作・テスト成功**
- **ヘルプ・ドキュメントも完全反映済み**
- **プロジェクトが完成状態** 