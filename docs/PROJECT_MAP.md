# 分散SNS関連年表bot プロジェクト概要

## 目的
「分散SNS関連年表」サイトの「今日はなんの日？」機能を自動化するMisskeyボット開発

## 基本仕様

### データソース
- **URL**: https://yuinoid.neocities.org/txt/my_dsns_timeline
- **特徴**: 850KB、日付レベル年表、JavaScript動的生成コンテンツ
- **更新**: 数ヶ月に1度（履歴追加+最新情報）

### 投稿機能
- **頻度**: 1日2回（00:01, 12:00）
- **フォーマット**: サイトの「今日はなんの日？」コーナーと同一
  ```
  今日は、
  <できごとリスト または "なんの日でもありません">
  だそうです！よかったね！
  ```

## 技術環境
- **プラットフォーム**: Misskey
- **運用**: Raspberry Pi 5 + Ubuntu Server
- **実装方針**: シンプル + 拡張可能設計

## 技術的課題

### JavaScript処理の再現
元サイトのJSロジック:
```javascript
// 今日の日付取得
var today = new Date();
var todayStr = ('00' + (today.getMonth() + 1)).slice(-2) + '月' + ('00' + today.getDate()).slice(-2) + '日';

// 年表から該当日付のイベントを抽出
$('#timeline_layout > div').each(function () {
  var eventYear = $(this).find('.year').text();
  var events = $(this).find('li');
  // 日付マッチング処理...
});
```

### HTML構造
```html
<div id="timeline_layout">
  <div id="1925">
    <h2 class="year">1925年</h2>
    <ul>
      <li class="thought culture">07月11日　Vladimir Vernadsky...</li>
    </ul>
  </div>
</div>
```

## システム設計（最適化版）

### アーキテクチャ設計: 責任分離型
```
main.py (ライフサイクル管理) → BotClient (WebSocket) → CommandRouter → Handlers
                              ↕
                           data_service ← SQLite
                           
```

### プロジェクト構造（最終整理版）
```
dsns_timeline_bot/
├── README.md              # プロジェクト概要・セットアップガイド
├── .env                   # 環境変数設定（59行、14項目）
├── .env.example           # 環境変数テンプレート
├── pytest.ini            # pytest設定ファイル
├── main.py                # メインアプリケーション（463行）
├── bot_client.py          # MiPA WebSocket管理（596行）
├── command_router.py      # コマンド解析・ルーティング（388行）
├── data_service.py        # データ取得・更新（873行）
├── config.py              # 設定管理（303行）
├── database.py            # SQLite操作（699行）
├── summary_manager.py     # 年代別概要管理（250行）
├── constants.py           # 定数管理（170行）
├── exceptions.py          # 例外クラス（398行）
├── dsnstypes.py           # 型定義（314行）
├── handlers/              # 応答処理群（単一責任）
│   ├── __init__.py        # ハンドラーエクスポート（23行）
│   ├── base_handler.py    # 共通基底クラス（94行）
│   ├── today_handler.py   # 今日のイベント処理（280行）
│   ├── date_handler.py    # 特定日付処理（55行）
│   ├── search_handler.py  # 検索機能（52行）
│   ├── help_handler.py    # ヘルプ表示（67行）
│   ├── status_handler.py  # ステータス監視機能（399行）
│   ├── decade_handler.py  # 年代別統計機能（277行）
│   └── category_handler.py # カテゴリ複合フィルタ機能（189行）
├── tests/                 # テストファイル群（20ファイル）
│   ├── test_refactoring_final.py        # リファクタリング統合テスト
│   ├── test_refactoring_comprehensive.py # リファクタリング包括的テスト
│   ├── test_refactoring_constants_exceptions.py # 定数・例外テスト
│   ├── test_refactoring_simple.py       # リファクタリング基本テスト
│   ├── test_status_functionality.py     # ステータス機能テスト
│   ├── test_decade_functionality.py     # 年代別機能テスト（1920年代～2020年代すべてをカバー）
│   ├── test_category_functionality.py   # カテゴリ機能テスト
│   ├── test_decade_category_integration.py # 年代＋カテゴリ複合機能テスト
│   ├── test_scheduled_posting.py        # 定期投稿テスト
│   ├── test_mention_detection.py        # メンション検出テスト
│   ├── test_bot_client_detailed.py      # ボットクライアント詳細テスト
│   ├── test_components.py               # コンポーネント統合テスト
│   ├── test_data_update.py              # データ更新テスト
│   ├── test_fixed_link_parsing.py       # リンク解析テスト
│   ├── test_real_data.py                # 実データテスト
│   ├── test_link_parsing.py             # リンク解析テスト
│   ├── test_final_message.py            # 最終メッセージテスト
│   ├── test_visibility_matching.py      # 可視性マッチングテスト
│   ├── test_visibility_change.py        # 可視性変更テスト
│   ├── test_dryrun.py                   # ドライランモードテスト
│   └── test_import.py                   # インポートテスト
├── utils/                 # ユーティリティ（3ファイル）
│   ├── fix_links_in_db.py # データベースリンク修正（74行）
│   ├── debug_link_issue.py # リンク問題デバッグ（104行）
│   └── rebuild_db.py      # データベース再構築（46行）
├── scripts/               # 運用スクリプト群（8ファイル）
│   ├── setup.sh           # 初期設定（45行）
│   ├── setup_main_service.sh # main.py常駐用systemdサービス設定（110行）
│   ├── setup_complete.sh  # 完全自動化設定スクリプト（159行）
│   ├── start_bot.sh       # systemd用起動スクリプト（8行）
│   ├── custom_service_examples.sh # systemdカスタマイズ例（138行）
│   ├── timer_customization_examples.sh # タイマーカスタマイズ例（152行）
│   ├── advanced_systemd_examples.sh # 高度なsystemd設定例（262行）
│   └── health_check.py    # 診断ツール（20行）
├── data/                  # データディレクトリ
│   ├── timeline.db        # SQLiteデータベース（7.6MB）
│   └── summaries/         # 年代別概要ファイル（1920s～2020s, template の計12ファイル）
│       ├── template.md    # 概要テンプレート
│       ├── 1920s.md       # 1920年代概要
│       ├── 1930s.md       # 1930年代概要
│       ├── 1940s.md       # 1940年代概要
│       ├── 1950s.md       # 1950年代概要
│       ├── 1960s.md       # 1960年代概要
│       ├── 1970s.md       # 1970年代概要
│       ├── 1980s.md       # 1980年代概要
│       ├── 1990s.md       # 1990年代概要
│       ├── 2000s.md       # 2000年代概要
│       ├── 2010s.md       # 2010年代概要
│       └── 2020s.md       # 2020年代概要
├── logs/                  # ログ出力ディレクトリ（3ファイル）
│   ├── bot.log           # ボットログ（133KB）
│   ├── dsns_bot.log      # メインログ（33KB）
│   └── test.log          # テストログ（701B）
├── docs/                  # ドキュメント（4ファイル）
│   ├── PROJECT_MAP.md     # プロジェクト概要（このファイル）
│   ├── DEVELOPMENT_GUIDE.md # 運用・開発ガイドライン
│   ├── REFACTORING_DOCUMENTATION.md # リファクタリング詳細説明
│   └── mipa_guide.md     # MiPA運用ガイド（801行）
├── requirements.txt       # Python依存関係（21パッケージ）
├── .gitignore            # Git除外設定
└── .venv/                # 仮想環境
```

## ファイル詳細説明

### メインアプリケーション

#### main.py (463行)
分散SNS関連年表botのメインエントリーポイント。ボットライフサイクル管理、コンポーネント統合、エラーハンドリングを担当。

**主要機能:**
- ボットライフサイクル管理（初期化、開始、終了、シャットダウン）
- コンポーネント統合（Config、Database、DataService、CommandRouter、BotClient）
- エラーハンドリングとログ管理
- シグナル処理（SIGINT/SIGTERM）
- ヘルスモニタリング

**アーキテクチャ:**
- DSNSTimelineBotクラスによる統合管理
- 初期化フロー: Config → Database → DataService → CommandRouter → BotClient
- 実行フロー: start_bot() → run_forever() → shutdown_bot()

**依存関係:**
- 外部: mipa (Misskeyボットライブラリ)
- 内部: config, database, data_service, command_router, bot_client

### 通信・ルーティング層

#### bot_client.py (596行)
MiPA WebSocketクライアント専用管理。WebSocket接続、再接続、メッセージ受信処理を担当。

**主要機能:**
- WebSocket接続管理（接続・切断・再接続）
- メンション検出とイベント処理
- リプライ・ノート投稿機能
- 接続状態監視とハートビート管理

**技術的特徴:**
- DSNSMiPABotクラスでMiPAのBotクラスを継承
- 複数チャンネル接続（main, home, global）
- ドライランモード対応
- エラー耐性のある再接続機能

#### command_router.py (388行)
コマンド解析とハンドラールーティング管理。メンション内容の解析からハンドラー選択・実行までを一元管理。

**主要機能:**
- 自然言語コマンド解析（日付、検索、ヘルプ等）
- ハンドラー選択とルーティング
- エラーハンドリングとフォールバック
- 統計情報収集
- デフォルト処理（不明なコマンド時はヘルプ表示）

**対応コマンド:**
- 日付指定: "5月1日"、"05月01日"
- 検索: "検索 キーワード"
- ヘルプ: "ヘルプ"、"使い方"
- カテゴリ機能: "カテゴリ dsns+tech"、"カテゴリ一覧"、"カテゴリ統計"、"カテゴリ分析 dsns"
  - 複合フィルタ: "カテゴリ dsns+tech-meme"（除外条件付き）
  - カテゴリ一覧: "カテゴリ一覧"
  - カテゴリ統計: "カテゴリ統計"
  - カテゴリ分析: "カテゴリ分析 dsns"、"カテゴリ分析 dsns+tech"
- ステータス: "ステータス"、"status"（システム監視）
  - 基本: "ステータス"、"status"
  - サーバー詳細: "ステータス サーバー"、"status server"
  - ボット詳細: "ステータス ボット"、"status bot"
  - 年表詳細: "ステータス 年表"、"status timeline"
- 年代別統計: "2000年代"、"90年代 代表"等
  - 統計: "2000年代"、"1990年代 統計"
  - 代表: "90年代 代表"、"2000年代 代表"
  - 概要: "1990年から1999年 概要"、"2010年代 概要"
- 年代＋カテゴリ複合: "2000年代 カテゴリ web+tech"
- 今日のイベント: "今日"、"きょう"、"today"
- デフォルト: ヘルプ表示（不明なコマンド時）

### データ処理層

#### data_service.py (873行)
年表データ取得・処理サービス。元サイトのJavaScript処理を再現して、HTMLから年表データを抽出し、データベースに保存・更新する機能を提供。

**主要機能:**
- **HTTPデータ取得**: aiohttp使用、SSL検証無効化、詳細ヘッダー設定
- **JavaScript処理の再現**: 複数日付パターンマッチング、日付抽出ロジック
- **年表データのパース・構造化**: BeautifulSoup4によるHTML解析
- **データベースへの保存・更新**: バッチ処理、重複チェック
- **「今日はなんの日？」機能**: 改良版フォーマット、日付強調
- **HTMLリンクのMarkdown変換**: テンポラリ形式経由の安全な変換
- **検索機能**: キーワード検索、文字数制限対応（3000文字）
- **URL生成機能**: 年表サイトの検索URL生成
- **ヘルスチェック機能**: 段階的状態監視（healthy/degraded/unhealthy）

**技術的特徴:**
- **エラーハンドリング**: DataServiceErrorカスタム例外、段階的回復
- **非同期処理**: コンテキストマネージャー対応、セッション管理
- **パフォーマンス最適化**: TCPConnector設定、タイムアウト管理
- **データ品質管理**: 除外パターン、ノイズ除去、妥当性チェック
- **メッセージフォーマット**: 改行保持、日付強調、太字処理
- **文字数制限**: 3000文字制限での切り詰め、残件数表示、共通メソッド`_truncate_message_with_events()`による統一処理

**処理フロー:**
1. **HTML取得**: HTTP接続、エラーハンドリング、レスポンス検証
2. **データ抽出**: BeautifulSoup解析、日付パターンマッチング
3. **データ変換**: HTMLリンク→Markdown、エンティティデコード
4. **データ保存**: SQLite保存、更新履歴記録
5. **メッセージ生成**: フォーマット処理、文字数制限適用（共通メソッド使用）

**対応日付パターン:**
- `(\d{2})月(\d{2})日` (05月01日)
- `(\d{1,2})月(\d{1,2})日` (5月1日)
- `(\d{2})/(\d{2})` (05/01)
- `(\d{1,2})/(\d{1,2})` (5/1)

**除外パターン:**
- 空行・記号のみ
- 参考情報・出典情報
- メタ情報（年表、タイムライン等）

**依存関係:**
- **外部**: aiohttp, BeautifulSoup4, html, urllib.parse
- **内部**: config, database

**テスト機能:**
- `test_data_service()`: スタンドアロン実行テスト
- 段階的テスト（初期化、ヘルスチェック、メッセージ生成）

#### database.py (699行)
SQLiteデータベース操作。年表データの永続化と検索機能を提供。

**主要機能:**
- SQLiteデータベースの初期化と管理
- 年表データの保存・更新・検索
- 日付別イベント取得
- データ統計情報の取得
- 更新履歴管理
- **カテゴリ複合フィルタ機能**: 複数カテゴリ指定・除外条件付き検索
- **カテゴリ統計機能**: 年代別・年別のカテゴリ分布集計
- **共起カテゴリ分析**: 指定カテゴリと共起するカテゴリの頻度分析
- **年代別＋カテゴリ複合検索**: 年代別条件とカテゴリ条件の組み合わせ

**データ構造:**
- timeline_events: 年表イベント（年、月、日、内容、カテゴリ）
- update_history: データ更新履歴
- インデックス: 日付別、年別、全文検索用

**技術的特徴:**
- TimelineEventデータクラス
- コンテキストマネージャーによる接続管理
- バッチ処理対応
- JSONエクスポート機能

### 設定・管理層

#### .env (59行)
環境変数設定ファイル。アプリケーションの動作に必要な設定値を管理。

**設定項目（14項目）:**
- **Misskey接続設定**: HOST、URL、TOKEN
- **データソース設定**: 年表URL、更新間隔
- **データベース設定**: SQLiteファイルパス
- **投稿設定**: 定期投稿時刻（POST_TIMES）、タイムゾーン
- **ログ設定**: ログレベル、ログファイルパス
- **HTTP設定**: タイムアウト、User-Agent、SSL設定
- **開発設定**: デバッグモード、ドライランモード（DRY_RUN_MODE）

**特徴:**
- セクション別に整理された構造
- 詳細なコメント付き
- 機密情報（トークン）を含むためGit管理対象外

#### config.py (303行)
アプリケーション設定管理。.envファイルから環境変数を読み込み、必要な検証を行う。

**主要機能:**
- .envファイルからの環境変数読み込み
- 設定値の検証とデフォルト値設定
- 設定エラーハンドリング
- 型変換とバリデーション

**設定項目:**
- Misskey接続設定（URL、トークン）
- データソース設定（年表URL、更新間隔）
- データベース設定（パス）
- 投稿設定（時刻（post_times）、タイムゾーン）
- ログ設定（レベル、ディレクトリ）
- HTTP設定（タイムアウト、User-Agent、SSL）
- 開発設定（デバッグモード、ドライランモード（dry_run_mode））

### リファクタリング追加ファイル（コード品質向上）

#### constants.py (リファクタリング追加)
全定数の一元管理ファイル。型安全性の向上とコードの一貫性を確保。

**主要機能:**
- **Visibility**: 投稿公開範囲の定数（public, home, followers, specified）
- **MessageLimits**: メッセージ制限の定数（MAX_LENGTH=3000, TRUNCATE_LENGTH=2997）
- **TimeFormats**: 時刻フォーマットの定数（POST_TIME_FORMAT, DATE_FORMAT等）
- **CommandTypes**: コマンドタイプの定数（TODAY, DATE, SEARCH, HELP, STATUS, DECADE）
- **ErrorMessages**: エラーメッセージの統一（各機能別エラーメッセージ）
- **SuccessMessages**: 成功メッセージの統一（各機能別成功メッセージ）
- **DefaultValues**: デフォルト値の集中管理（タイムアウト、リトライ回数等）

**技術的特徴:**
- Literal型による型安全性の確保
- 全モジュールでの一貫した定数使用
- エラーメッセージの統一化
- 保守性の向上

#### exceptions.py (リファクタリング追加)
階層化された例外クラス管理ファイル。統一されたエラーハンドリングパターンを提供。

**主要機能:**
- **DSNSBotError**: 基底例外クラス（全例外の親クラス）
- **DataServiceError**: データサービス関連エラー（HTTP接続、データ処理等）
- **BotClientError**: ボットクライアント関連エラー（WebSocket接続、投稿等）
- **CommandParseError**: コマンド解析エラー（パース失敗、無効なコマンド等）
- **DatabaseError**: データベース関連エラー（接続、クエリ、トランザクション等）
- **ConfigError**: 設定関連エラー（環境変数、設定値等）
- **HandlerError**: ハンドラー関連エラー（処理失敗、データ取得等）
- **StatusHandlerError**: ステータス機能関連エラー
- **DecadeHandlerError**: 年代別機能関連エラー
- **SummaryError**: 概要管理関連エラー

**技術的特徴:**
- 階層化された例外構造
- 詳細なエラー情報（コンテキスト、ハンドラー情報）
- 統一されたエラーハンドリングパターン
- デバッグ情報の充実

#### dsnstypes.py (リファクタリング追加)
型定義管理ファイル。型安全性の完全化とIDEサポートの向上を実現。

**主要機能:**
- **CommandDict**: コマンド解析結果の型安全な辞書定義
- **EventData**: イベントデータの型定義（年、月、日、内容、カテゴリ）
- **DecadeStatistics**: 年代別統計情報の型定義
- **StatusInfo**: ステータス情報の型定義（基本、サーバー、ボット、年表）
- **StatusSystemInfo**: システム情報の型定義（CPU、メモリ、ディスク）
- **StatusDatabaseInfo**: データベース情報の型定義
- **VisibilityType**: 公開範囲の制約付き型（Literal型）
- **CommandTypes**: コマンドタイプの制約付き型（Literal型）

**技術的特徴:**
- TypedDictによる型安全な辞書定義
- Literal型による制約付き型定義
- 複合型定義による構造化
- 型ヒントの完全化によるIDEサポート向上

### ハンドラー層

#### handlers/ (全ファイル)
各種コマンド処理ハンドラー。単一責任原則に基づいて機能別に分離。

**base_handler.py (61行)**
全ハンドラーの基底クラス。共通機能を提供。
- 共通初期化処理（config, database, data_service, bot_client保持）
- 全ハンドラーで使用する共通メソッド提供
- **共通URL付加処理**: `_add_timeline_url()`メソッドによる統一処理

**today_handler.py (306行)**
今日のイベント処理専用ハンドラー。既存TodayEventHandlerのロジックを移行・統合。

**主要機能:**
- **基本応答処理**: 今日のイベントメッセージ生成・返信
- **定期投稿機能**: 設定時刻での自動投稿（Phase 3機能）
- **文字数制限処理**: 3000文字制限での切り詰め（Misskey安全制限）
- **URL付加機能**: 年表サイトリンクの自動付加（共通メソッド使用）
- **投稿履歴管理**: 重複投稿防止（23時間間隔チェック）
- **エラー統計**: エラー回数・時刻の自動収集
- **状態監視**: ハンドラー状態情報の提供

**定期投稿仕様:**
- 投稿タイミング: 設定時刻の前後5分以内
- 公開範囲: 設定可能（SCHEDULED_POST_VISIBILITY環境変数）
  - デフォルト: ホーム（home）
  - 選択肢: public, home, followers, specified
- 重複防止: 同日内23時間間隔チェック
- フォールバック: URL付加失敗時の安全処理

**メッセージ処理:**
- `_truncate_message()`: 文字数制限処理
- `_get_fallback_message()`: データ取得エラー時
- `_get_error_message()`: システムエラー時
- ヘッダー/フッター保持の賢い切り詰め

**date_handler.py (52行)**
特定日付のイベント処理専用ハンドラー。
- 月日指定でのイベント取得・応答
- URL付加機能（年表サイト検索リンク、共通メソッド使用）
- エラーハンドリング（データサービス未利用時等）

**search_handler.py (49行)**
検索機能専用ハンドラー。
- キーワード検索の実行・結果返信
- URL付加機能（年表サイト検索リンク、共通メソッド使用）  
- エラーハンドリング（検索失敗時等）

**help_handler.py (49行)**
ヘルプ表示専用ハンドラー。使い方を表示。

**status_handler.py (375行)**
ステータス監視機能専用ハンドラー。階層化ステータス情報を表示。

**主要機能:**
- **階層化ステータス表示**: 基本・サーバー・ボット・年表の4段階詳細表示
- **サブコマンド対応**: 「ステータス サーバー」「ステータス ボット」「ステータス 年表」
- **システム情報取得**: CPU、メモリ、ディスク使用率の実時間取得
- **データベース詳細情報**: 最古・最新イベント、年代別分布、更新履歴
- **パフォーマンス監視**: 応答時間、処理成功率、エラー率の計算
- **統合ステータス取得**: `_get_bot_status()`メソッドによる包括的情報収集

**技術的特徴:**
- psutil統合によるシステム情報取得
- データベース詳細情報の段階的取得
- エラーハンドリングとフォールバック処理
- デバッグログによる詳細追跡

**decade_handler.py (277行)**
年代別統計機能専用ハンドラー。年代別のイベント統計、代表的なイベント、概要表示を提供。

**主要機能:**
- **年代別統計**: 指定年代のイベント数と統計情報
  - 総イベント数、年平均、最多・最少年の特定
  - 年別分布のグラフ風表示（█文字による可視化）
  - 統計情報の詳細分析
- **代表的なイベント**: 年代別の重要イベントの抽出・列挙
  - HTMLクラス（span.str、a.str、span.str2、a.str2）による重要度判定
  - 重複除去と時系列順ソート
  - 文字数制限対応（3000文字、共通メソッド使用）
- **年代別概要**: 外部Markdownファイルによる概要管理
  - SummaryManagerによるテンプレート管理
  - 年代別の詳細な背景説明
- **柔軟な年代表記対応**: 「2000年代」「90年代」「1990年から1999年」等
- **年代＋カテゴリ複合機能**: 年代別条件とカテゴリ条件の組み合わせ

**対応コマンド:**
- `2000年代` → 2000年代の統計情報
- `90年代 代表` → 1990年代の代表的なイベント
- `1990年から1999年 概要` → 1990年代の概要
- `2000年代 カテゴリ web+tech` → 2000年代のweb・techカテゴリ

**技術的特徴:**
- **SummaryManager統合**: 外部Markdownファイルによる概要管理
- **重要度計算**: HTMLクラスによる自動重要度判定
- **共通処理統合**: 文字数制限・URL付加の共通メソッド使用
- **データベース年代別クエリ**: get_decade_statistics()、get_events_by_year_range()
- **カテゴリ複合対応**: 年代別＋カテゴリ複合検索機能
- **エラーハンドリング**: 段階的フォールバック処理
- **ログ出力**: 処理開始・完了・エラーの詳細追跡

**処理フロー:**
1. **コマンド解析**: sub_type（統計・代表・概要）の判定
2. **データ取得**: データベースから年代別データ取得
3. **重要度計算**: HTMLクラスによる重要度判定（代表イベント）
4. **フォーマット処理**: 統計情報・イベントリスト・概要の整形
5. **文字数制限**: 共通メソッドによる3000文字制限処理
6. **URL付加**: 年表サイト検索リンクの自動付加

**category_handler.py (189行)**
カテゴリ複合フィルタ機能専用ハンドラー。カテゴリ指定・除外条件・統計・分析機能を提供。

**主要機能:**
- **カテゴリ複合フィルタ**: 複数カテゴリ指定・除外条件付き検索
  - `カテゴリ dsns+tech` → dsnsかつtechカテゴリのイベント
  - `カテゴリ dsns+tech-meme` → dsns・techだがmeme以外のイベント
- **カテゴリ一覧表示**: 利用可能なカテゴリ一覧の表示
- **カテゴリ統計**: 年代別・年別のカテゴリ分布表示
- **カテゴリ分析**: 指定カテゴリと共起するカテゴリの頻度分析
  - `カテゴリ分析 dsns` → dsnsとよく組み合わさるカテゴリの統計
  - `カテゴリ分析 dsns+tech` → 複合カテゴリ条件での分析

**対応コマンド:**
- `カテゴリ dsns+tech` → カテゴリ複合フィルタ
- `カテゴリ一覧` → カテゴリ一覧表示
- `カテゴリ統計` → カテゴリ分布統計
- `カテゴリ分析 dsns` → 共起カテゴリ分析

**技術的特徴:**
- **複合条件解析**: カテゴリ指定・除外条件の柔軟な解析
- **共起分析**: 指定カテゴリと共起するカテゴリの頻度集計
- **統計機能**: 年代別・年別のカテゴリ分布可視化
- **共通処理統合**: 文字数制限・URL付加の共通メソッド使用
- **エラーハンドリング**: 存在しないカテゴリの適切な処理
- **ログ出力**: 処理開始・完了・エラーの詳細追跡

**処理フロー:**
1. **コマンド解析**: sub_type（filter/list/statistics/analysis）の判定
2. **カテゴリ解析**: 指定カテゴリ・除外カテゴリの解析
3. **データ取得**: データベースからカテゴリ条件に合うデータ取得
4. **分析処理**: 統計・共起分析の実行
5. **フォーマット処理**: 結果の整形・可視化
6. **文字数制限**: 共通メソッドによる3000文字制限処理
7. **URL付加**: 年表サイト検索リンクの自動付加

**共通機能（全ハンドラー）:**
- **URL生成・付加**: `data_service.generate_timeline_url()`使用、共通メソッド`_add_timeline_url()`による統一処理
- **エラーハンドリング**: 段階的フォールバック処理
- **ログ出力**: 処理開始・完了・エラーの詳細ログ
- **文字数管理**: メッセージ長の監視・調整

### ユーティリティ・メンテナンス

#### fix_links_in_db.py (74行)
データベース内のHTMLリンクをMarkdown形式に変換するユーティリティ。

#### debug_link_issue.py (104行)
リンク処理の問題をデバッグするための診断ツール。

### ドキュメント

#### mipa_guide.md (801行)
MiPAライブラリの使用方法、Misskeyボット開発のベストプラクティス、運用ノウハウをまとめたガイド。

#### DEVELOPMENT_GUIDE.md (新規追加)
systemd自動化設定後の運用・開発ガイドライン。日常運用、開発ワークフロー、トラブルシューティング、セキュリティ、パフォーマンス監視、緊急時対応を詳細に説明。

#### REFACTORING_DOCUMENTATION.md (リファクタリング追加)
大規模リファクタリング作業の詳細ドキュメント。新しい定数、例外、型定義の説明、使用例、ベストプラクティス、テスト実行方法、移行ガイドを包括的に記載。

#### REFACTORING_PLAN.md (リファクタリング追加)
リファクタリング作業の計画書。現状分析、改善目標、実装フェーズ、成功指標、実装ツール、スケジュールを詳細に記載。

### テスト・開発ツール

#### test_*.py ファイル群
- **test_components.py (331行)**: コンポーネント統合テスト
- **test_dryrun.py (101行)**: ドライランモードテスト
- **test_import.py (14行)**: インポートテスト
- **test_mention_detection.py (404行)**: メンション検出テスト
- **test_scheduled_posting.py (240行)**: 定期投稿テスト
- **test_bot_client_detailed.py (271行)**: ボットクライアント詳細テスト
- **test_data_update.py (130行)**: データ更新テスト
- **test_fixed_link_parsing.py (128行)**: リンク解析テスト
- **test_real_data.py (102行)**: 実データテスト
- **test_link_parsing.py (88行)**: リンク解析テスト
- **test_final_message.py (82行)**: 最終メッセージテスト
- **test_visibility_matching.py (165行)**: 可視性マッチングテスト
- **test_decade_functionality.py (新規追加)**: 年代別機能テスト
- **test_status_functionality.py (新規追加)**: ステータス機能包括的テスト
- **test_category_functionality.py (新規追加)**: カテゴリ機能包括的テスト
  - カテゴリ複合フィルタ、カテゴリ一覧、カテゴリ統計、カテゴリ分析
  - 複数カテゴリ指定・除外条件・存在しないカテゴリの処理
  - 共起カテゴリ分析、年代別・年別カテゴリ分布
- **test_decade_category_integration.py (新規追加)**: 年代＋カテゴリ複合機能テスト
  - 年代別＋カテゴリ複合条件の解析・処理
  - 統計・代表・概要でのカテゴリ複合対応
  - 除外カテゴリの複数指定・複雑な条件の処理
- **test_refactoring_comprehensive.py (リファクタリング追加)**: リファクタリング包括的テスト
  - 定数、例外、型定義の統合テスト
  - データサービス、データベース、ハンドラーの動作確認
  - エラーハンドリングワークフローの検証
  - 定数使用パターンのテスト
- **test_refactoring_final.py (リファクタリング追加)**: リファクタリング統合テスト
  - 全機能の統合動作確認
  - リファクタリング完了の最終検証
  - 8つのテストカテゴリによる包括的検証

## 運用フロー
1. **dsns-timeline-bot-main.service** → main.py（常駐・メンション応答 + 定期投稿）
2. **dsns-bot-data-update.timer** → データ更新（毎日03:00）
3. **dsns-bot-backup.timer** → バックアップ（毎日04:00）
4. **共通DB** → SQLite（全サービス共有）

## 実装アプローチ

### Phase 1: 基本機能 ✅
1. **データ取得**: HTMLパース + JavaScript処理再実装
2. **定期投稿**: systemd timer + 単発スクリプト
3. **対話処理**: MiPA常駐ボット
4. **データ管理**: SQLite + 自己文書化コード

### Phase 2: 拡張機能 ✅
1. **日付リクエスト**: 柔軟な日付解析
   - 対応形式: `5月1日`, `０５月０１日`, `5月1日のできごと教えて`
2. **検索機能**: キーワード検索 + リプライ（3000文字制限対応）
3. **対話機能**: ヘルプ表示
4. **ヘルスチェック**: 段階的状態監視（healthy/degraded/unhealthy）
5. **URL生成**: 年表サイト検索URL生成・自動付加
6. **エラー耐性**: 段階的回復、部分機能継続

### Phase 4: カテゴリ統計・分析機能 ✅（新規追加）
1. **カテゴリ統計表示機能**: 年代別・年別のカテゴリ分布を表示
   - `カテゴリ統計` コマンドで全体・年代別・年別のカテゴリ分布
   - カテゴリ別件数、年代別分布、年別分布の可視化
2. **複合カテゴリ分析機能**: 指定カテゴリと組み合わせられるカテゴリの統計
   - `カテゴリ分析 dsns` でdsnsとよく共起するカテゴリの頻度表示
   - `カテゴリ分析 dsns+tech` で複合カテゴリ条件での分析
   - 共起カテゴリの頻度順表示、関連性の可視化
3. **カテゴリ関連性分析機能**: カテゴリ間の関連性（共起）を分析
   - 指定カテゴリをすべて含むイベントの抽出
   - そのイベントに含まれる他のカテゴリのカウント
   - 結果を頻度順で返す統計分析
4. **テスト・ヘルプ反映**: 統計・分析機能の包括的テストとドキュメント更新
   - カテゴリ分析機能のテストケース作成・実行
   - ヘルプメッセージ・README・PROJECT_MAPの更新

### Phase 5: 年代別統計機能 ✅（新規追加）
1. **年代別統計**: 指定年代のイベント数と統計情報
   - 対応年代: 1920年代～2020年代（全11年代）
   - 統計情報: 総イベント数、年平均、最多・最少年、年別分布
   - 可視化: グラフ風表示（█文字による年別分布）
2. **代表的なイベント**: 年代別の重要イベントの抽出・列挙
   - 元HTMLの特定クラス（span.str、a.str、span.str2、a.str2）を利用
   - 重要度計算: HTMLクラスによる自動重要度判定
   - 重複除去: 同じ内容のイベントは1つだけ表示
   - 時系列順ソート: 年→月→日の順序で整理
3. **年代別概要**: 外部Markdownファイルによる概要管理
   - SummaryManagerによるテンプレート管理
   - 年代別の詳細な背景説明
   - 外部ファイル: data/summaries/配下のMarkdownファイル（1920s～2020s）
4. **柔軟なコマンド解析**: 様々な年代表記への対応
   - 「1920年代」～「2020年代」「90年代」「1990年から1999年」等
   - サブコマンド: 統計、代表、概要
5. **共通処理統合**: 文字数制限・URL付加の統一処理
   - 3000文字制限対応（共通メソッド使用）
   - 年表サイト検索リンクの自動付加

### Phase 3: 年代＋カテゴリ複合機能 ✅（完了）
1. **年代別＋カテゴリ複合条件対応**: decade_handler.pyで実装済み
   - `2000年代 カテゴリ web+tech` パターン対応
   - 年代別統計・代表・概要すべてでカテゴリ複合対応
   - 除外カテゴリの複数指定や複雑な条件も正しく解析・反映
2. **統合テスト完了**: 全てのケースが成功し、警告も解消
   - 除外カテゴリの複数指定や複雑な条件も正しく動作
   - 存在しないカテゴリや概要のカテゴリフィルタ表示も期待通り
   - 年代別URL付加処理の警告も解消

### Phase 3: 定期投稿機能 ✅（完了）
1. **定期投稿システム**: ✅ today_handler.pyで実装済み
   - 設定時刻での自動投稿（前後5分以内判定）
   - ホーム公開範囲での投稿
   - 重複投稿防止（23時間間隔）
   - エラー統計・状態監視
2. **投稿履歴管理**: ✅ 実装済み
3. **systemd自動化**: ✅ 完全実装
   - main.py常駐サービス（メンション応答 + 定期投稿）
   - データ更新・バックアップタイマー
   - 自動再起動・エラー復旧機能

### Phase 6: ステータス機能 ✅（新規追加）
1. **階層化ステータス表示**: ✅ status_handler.pyで実装済み
   - 基本ステータス: 接続状態、稼働時間、処理統計、データベース情報
   - サーバー詳細: システム情報（CPU、メモリ、ディスク）、ネットワーク情報、設定情報
   - ボット詳細: 処理統計、ハンドラー情報、パフォーマンス情報
   - 年表詳細: データベース詳細、データ範囲、年代別分布、データソース情報
2. **サブコマンド対応**: ✅ 日本語・英語両対応
   - 「ステータス サーバー」「ステータス ボット」「ステータス 年表」
   - 「status server」「status bot」「status timeline」
3. **システム監視**: ✅ psutil統合
   - CPU、メモリ、ディスク使用率の実時間取得
   - パフォーマンス監視（応答時間、処理成功率）
4. **包括的テスト**: ✅ test_status_functionality.py
   - 全ステータス機能の動作確認
   - コマンド解析テスト

## 技術スタック
- **ボット**: MiPA (Python, Discord.py-like)
- **スクレイピング**: BeautifulSoup4 + aiohttp
- **HTTP処理**: aiohttp (SSL無効化、詳細ヘッダー設定)
- **HTMLパース**: BeautifulSoup4 + 正規表現
- **テキスト処理**: html (エンティティデコード), urllib.parse (URLエンコード)
- **システム監視**: psutil (CPU、メモリ、ディスク使用率取得)
- **スケジューリング**: systemd timer + main.py内定期チェック
- **DB**: SQLite
- **運用**: systemd service（完全自動化）
- **仮想環境**: Python venv（.venv）
- **ログ管理**: systemd journal + ファイルログ

## ログ出力仕様
- **レベル**: DEBUG, INFO, WARNING, ERROR
- **出力先**: 
  - **systemd journal**: `sudo journalctl -u dsns-timeline-bot-main`
  - **ファイルログ**: `logs/bot.log`, `logs/dsns_bot.log`
- **出力内容**: 
  - 処理ステップの詳細追跡
  - HTTP接続状況
  - データ処理統計
  - エラー詳細情報
  - ヘルスチェック結果
  - 定期投稿実行状況
  - メンション応答状況

## 基本運用・開発方法

### 日常運用
```bash
# サービス状態確認
sudo systemctl status dsns-timeline-bot-main

# ログ確認（リアルタイム）
sudo journalctl -u dsns-timeline-bot-main -f

# サービス再起動（コード修正後）
sudo systemctl restart dsns-timeline-bot-main
```

### 開発ワークフロー
```bash
# 1. コード修正
vim main.py

# 2. サービス再起動
sudo systemctl restart dsns-timeline-bot-main

# 3. デバッグが必要な場合
sudo systemctl stop dsns-timeline-bot-main
python main.py  # 手動実行
```

### 詳細ガイド
- **DEVELOPMENT_GUIDE.md**: 完全な運用・開発ガイドライン

## LLMセッション継続性
- **PROJECT_MAP.md**: 全体ガイド（このファイル）
- **DEVELOPMENT_GUIDE.md**: 運用・開発ガイドライン
- **自己文書化**: 各ファイルに詳細docstring + 型ヒント
- **診断ツール**: data_service.py内蔵のhealth_check + test_data_service
- **ファイル数制限**: 重要ファイル10個以下

## 主要考慮点
- **リソース効率**: Pi5最適化（分離型で軽量化）
- **障害耐性**: データ更新失敗でもボット機能継続（degraded状態）
- **保守性**: 機能分離によるデバッグ容易化
- **LLM対応**: 新セッションでの迅速な全体把握
- **文字数制限**: Misskey投稿制限（3000文字）への対応
- **エラー回復**: 段階的なフォールバック機能
- **自動化**: systemdによる完全自動運用
- **監視**: 統合ログ管理とエラー検出
- **ステータス監視**: 階層化ステータス表示による包括的監視

## 開発優先度
1. ✅ 基本定期投稿（JSロジック再現）
2. ✅ 日付リクエスト（柔軟解析）
3. ✅ 検索・対話機能
4. ✅ エラー耐性・ヘルスチェック
5. ✅ 文字数制限対応
6. ✅ URL生成・リンク処理
7. ✅ カテゴリ複合フィルタ機能（フェーズ1-2）
8. ✅ 年代別統計機能（フェーズ5）
9. ✅ systemd自動化設定（完全運用対応）
10. ✅ 重複処理の統一（文字数制限・URL付加）
11. ✅ ステータス機能の完全実装（階層化監視機能）
12. ✅ デフォルトコマンドの改善（ヘルプ表示優先）
13. ✅ 大規模リファクタリング作業（コード品質向上）
14. ✅ カテゴリ統計・分析機能（フェーズ4）
15. ✅ 年代＋カテゴリ複合機能（フェーズ3）
16. ✅ ヘルプ・ドキュメント反映（フェーズ7）

## 既存参考bot
- サイト記載: @dsns_today_event@tanoshii.site
- 実装参考として調査可能

## 現在の実装状況
- ✅ 基本アーキテクチャ完成
- ✅ データ取得・処理機能実装（高度なエラーハンドリング含む）
- ✅ ボット通信機能実装
- ✅ コマンド処理機能実装
- ✅ テスト機能実装（スタンドアロン実行対応）
- ✅ ユーティリティ・メンテナンス機能実装
- ✅ ドキュメント整備
- ✅ 環境変数設定管理
- ✅ ヘルスチェック・段階的状態監視
- ✅ 文字数制限・フォーマット最適化（3000文字制限）
  - 共通メソッド`_truncate_message_with_events()`による統一処理
  - 4つのメソッドで重複コードを削除（約100行）
  - 保守性向上、一貫性確保、バグ修正効率化
- ✅ URL付加機能（全ハンドラー共通）
  - 共通メソッド`_add_timeline_url()`による統一処理
  - 4つのハンドラーで重複コードを削除（約30行）
  - エラーハンドリング統一、フォールバック処理改善
- ✅ 定期投稿機能（today_handler.py）
- ✅ 年代別統計機能実装（新規追加）
  - DecadeHandler（189行）、SummaryManager、年代別概要ファイル
  - 柔軟なコマンド解析、データベース年代別クエリ
  - HTMLクラスによる重要度判定、重複除去、時系列順ソート
  - 統計情報の可視化（グラフ風表示）、共通処理統合
- ✅ カテゴリ複合フィルタ機能実装（新規追加）
  - CategoryHandler（189行）、複数カテゴリ指定・除外条件対応
  - カテゴリ一覧・統計・分析機能、共起カテゴリ分析
  - 年代別＋カテゴリ複合機能、複雑な条件の解析・処理
  - 包括的テスト・ヘルプ・ドキュメント反映
- ✅ 運用スクリプト実装（scripts/配下）
  - setup_main_service.sh: main.py常駐用systemdサービス設定
  - setup_complete.sh: 完全自動化設定スクリプト
  - start_bot.sh: systemd用起動スクリプト
  - custom_service_examples.sh: systemdカスタマイズ例
  - timer_customization_examples.sh: タイマーカスタマイズ例
  - advanced_systemd_examples.sh: 高度なsystemd設定例
- ✅ systemd自動化設定完了
  - dsns-timeline-bot-main.service: main.py常駐サービス
  - dsns-bot-data-update.timer: データ更新タイマー
  - dsns-bot-backup.timer: バックアップタイマー
- ✅ ステータス機能の完全実装（新規追加）
  - 階層化ステータス表示（基本・サーバー・ボット・年表）
  - サブコマンド対応（日本語・英語両対応）
  - システム情報取得（CPU、メモリ、ディスク使用率）
  - データベース詳細情報（最古・最新イベント、年代別分布）
  - パフォーマンス監視（応答時間、処理成功率）
  - 包括的テスト機能（test_status_functionality.py）
- ✅ デフォルトコマンドの改善（新規追加）
  - 不明なコマンド時のヘルプ表示優先
  - 包括的ヘルプメッセージの実装
  - ユーザビリティの向上
- ✅ 大規模リファクタリング作業完了（新規追加）
  - 新しい定数ファイル (constants.py) - 全定数の一元管理
  - 新しい例外クラス (exceptions.py) - 階層化された例外処理
  - 新しい型定義 (dsnstypes.py) - 型安全性の完全化
  - 包括的テスト (test_refactoring_comprehensive.py) - 統合テスト
  - 統合テスト (test_refactoring_final.py) - 最終検証
  - ドキュメント (REFACTORING_DOCUMENTATION.md) - 詳細説明
  - 型ヒントの完全化 - 全ファイルで型安全性向上
  - エラーハンドリングの統一 - 一貫した例外処理パターン
  - コードの一貫性 - 定数使用による統一
  - 開発効率の向上 - IDEサポートとドキュメント充実

## データ処理の詳細仕様

### HTMLリンク処理フロー
1. `<a href="URL">テキスト</a>` → `LINKSTARTURLLINKMIDDLETEXTLINKEND`（テンポラリ変換）
2. 他のHTMLタグ処理（`<span class="str">` → `**text**`、`<br>` → `\n`）
3. 残りのHTMLタグ削除
4. `LINKSTART...LINKEND` → `[text](URL)`（Markdown変換）
5. HTMLエンティティデコード

### メッセージフォーマット仕様
- **基本構造**: `今日は、\n\n<events>\n\nだそうです！よかったね！`
- **イベントフォーマット**: `**YYYY年**MM月DD日　<content>`
- **日付強調**: 対象日付を`**MM月DD日**`で強調
- **改行保持**: 元HTMLの`<br>`タグによる改行を保持
- **文字数制限**: 3000文字制限（Misskey安全制限）、超過時は賢い切り詰め
- **URL付加**: 年表サイト検索リンクの自動付加、失敗時フォールバック

### ヘルスチェック仕様
- **healthy**: 全チェック成功
- **degraded**: HTTP接続失敗だがDB正常（既存データで動作可能）
- **unhealthy**: 複数チェック失敗または重要機能停止

### 定期投稿仕様（Phase 3）
- **投稿タイミング**: 設定時刻（POST_TIMES）の前後5分以内
- **投稿間隔**: 同日内23時間間隔での重複防止
- **公開範囲**: 設定可能（SCHEDULED_POST_VISIBILITY環境変数）
  - デフォルト: ホーム（home）
  - 選択肢: public, home, followers, specified
- **投稿内容**: 今日のイベント + 年表サイトリンク
- **エラー処理**: 統計収集、フォールバック処理
- **状態監視**: 投稿履歴、エラー履歴の自動管理
- **自動化**: systemdサービスによる24時間常駐
- **復旧機能**: エラー時の自動再起動

## 修正履歴

### 2025-07-06: デフォルトコマンドの改善とヘルプメッセージの更新
- **目的**: ユーザビリティの向上と包括的なヘルプ機能の提供
- **実装内容**:
  - **デフォルトコマンド変更**: 不明なコマンド時の処理を「今日のイベント」から「ヘルプ表示」に変更
  - **ヘルプメッセージ拡張**: 現状の全機能に対応した包括的なヘルプメッセージに更新
  - **フォールバック処理改善**: エラー時もヘルプ表示を優先
- **技術的改善**:
  - **CommandRouter修正**: parse_command()のデフォルト処理変更
  - **ルーティング改善**: route_message()のフォールバック処理変更
  - **HelpHandler更新**: 全機能を網羅したヘルプメッセージ
- **改善効果**:
  - **ユーザビリティ向上**: 不明なコマンド時に利用可能な機能を即座に確認可能
  - **親切な体験**: エラー時でもヘルプ情報を提供
  - **機能発見**: ユーザーが新しい機能を発見しやすくなる
- **結果**: より親切で使いやすいボットインターフェースを実現

### 2025-07-06: ステータス機能の完全実装と改善
- **目的**: 階層的な監視機能の実装と実用的なステータス表示の実現
- **実装内容**:
  - **階層化ステータス機能**:
    - 基本ステータス: 接続状態、稼働時間、処理統計、データベース情報
    - サーバー詳細: システム情報（CPU、メモリ、ディスク）、ネットワーク情報、設定情報
    - ボット詳細: 処理統計、ハンドラー情報、パフォーマンス情報
    - 年表詳細: データベース詳細、データ範囲、年代別分布、データソース情報
  - **サブコマンド対応**: 「ステータス サーバー」「ステータス ボット」「ステータス 年表」
  - **日本語・英語両対応**: 「status server」「status bot」「status timeline」
  - **システム情報取得**: psutil使用によるCPU、メモリ、ディスク使用率の実時間取得
  - **データベース詳細情報**: 最古・最新イベント、年代別分布、更新履歴の取得
  - **パフォーマンス監視**: 平均・最大・最小応答時間、処理成功率の計算
- **技術的改善**:
  - **StatusHandler拡張**: `_get_bot_status()`メソッドによる統合ステータス取得
  - **システム情報取得**: `_get_system_info()`メソッドによるpsutil統合
  - **データベース詳細取得**: `_get_database_details()`メソッドによる詳細情報取得
  - **BotClient拡張**: `get_client_status()`メソッドによるメモリ使用量等の取得
  - **CommandRouter拡張**: `get_router_status()`メソッドによる処理統計取得
  - **コマンド解析拡張**: サブコマンド対応の追加
- **テスト機能**:
  - **test_status_functionality.py**: 全ステータス機能の包括的テスト
  - **モックデータ**: 実用的なテストデータによる動作確認
  - **コマンド解析テスト**: 日本語・英語両方のサブコマンド解析テスト
- **問題修正**:
  - **処理成功率表示**: 異常値（9959.5%）→ 正常値（99.6%）に修正
  - **最終接続時刻**: None → 正常な時刻表示に修正
  - **psutil警告**: 未インストール時の適切なフォールバック処理
  - **表示フォーマット**: パーセントフォーマットの適切な処理
- **改善効果**:
  - **監視機能**: 管理者がボットの状態を包括的に把握可能
  - **階層化表示**: 基本→詳細の段階的な情報提供
  - **実用性**: 実際の運用で必要な情報を網羅
  - **保守性**: モジュール化された設計による拡張性
  - **テスト性**: 包括的なテストによる品質保証
- **結果**: 完全に実用的な監視機能を実現

### 2025-07-05: 重複処理の統一（文字数制限・URL付加）
- **目的**: コードの保守性向上と一貫性確保のため、重複処理を統一
- **実装内容**:
  - **文字数制限処理の統一**:
    - `data_service.py`に`_truncate_message_with_events()`共通メソッドを追加
    - 4つのメソッドで重複していた文字数制限処理を統一
      - `get_today_events_message()`: 今日のイベント処理
      - `search_events_message()`: 検索結果処理
      - `get_date_events_message()`: 特定日付処理
      - `_handle_representative()`: 年代別代表イベント処理
    - 約100行の重複コードを削除
  - **URL付加処理の統一**:
    - `handlers/base_handler.py`に`_add_timeline_url()`共通メソッドを追加
    - 4つのハンドラーで重複していたURL付加処理を統一
      - `today_handler.py`: 今日のイベント処理
      - `date_handler.py`: 特定日付処理
      - `search_handler.py`: 検索結果処理
      - `decade_handler.py`: 年代別処理（3箇所）
    - 約30行の重複コードを削除
- **改善効果**:
  - **保守性向上**: 共通ロジックが1箇所に集約
  - **一貫性確保**: 全機能で同じ処理パターン
  - **コード量削減**: 合計約130行の重複コードを削除
  - **バグ修正効率**: 修正が1箇所で済む
  - **拡張性**: 新しい機能追加が容易
- **技術的詳細**:
  - 文字数制限: 3000文字制限、段階的イベント追加、残件数表示
  - URL付加: 年表サイト検索URL生成、エラーハンドリング、フォールバック処理
  - エラー処理: 失敗時は元のメッセージを返す安全な設計
- **結果**: コードの品質と保守性が大幅に向上

### 2025-07-04: 年代別統計機能の実装
- **新機能**: 年代別統計、代表的なイベント、年代別概要機能を追加
- **実装内容**:
  - DecadeHandler: 年代別統計機能専用ハンドラー
  - SummaryManager: 外部Markdownファイルによる概要管理
  - 年代別概要ファイル: data/summaries/配下に各年代の概要
  - データベース年代別クエリ: get_events_by_decade()メソッド追加
  - コマンド解析拡張: 年代コマンド対応追加
  - テスト機能: test_decade_functionality.py追加
- **対応コマンド**: 「2000年代」「90年代 代表」「1990年から1999年 概要」等
- **結果**: 年代別の統計情報、重要イベント、背景概要を提供可能

### 2025-07-04: 定期投稿機能の修正
- **問題**: MiPAの`start()`メソッドがメインループをブロックし、定期投稿が実行されない
- **原因**: `bot_client.py`の`connect()`メソッドで`await self.mipa_bot.start()`が無限ループとなり、メインループに制御が戻らない
- **修正**: MiPAの`start()`を`asyncio.create_task`でバックグラウンド実行し、`connect()`を即returnするよう変更
- **結果**: 定期投稿機能が正常に動作するようになった

### 2025-07-04: systemd自動化設定の実装
- **目的**: Raspberry Pi再起動時の自動起動と24時間無人運用の実現
- **実装内容**:
  - **dsns-timeline-bot-main.service**: main.py常駐サービス
    - 仮想環境対応（.venv/bin/python使用）
    - 自動再起動設定（Restart=always）
    - セキュリティ設定（ProtectSystem=strict等）
    - ログ統合（journalctl対応）
  - **dsns-bot-data-update.timer**: データ更新タイマー
    - 毎日03:00にデータ更新実行
    - ランダム遅延（RandomizedDelaySec=1800）
  - **dsns-bot-backup.timer**: バックアップタイマー
    - 毎日04:00にDBバックアップ実行
    - 7日以上古いバックアップ自動削除
  - **scripts/start_bot.sh**: systemd用起動スクリプト
    - 仮想環境有効化
    - main.py実行
- **管理コマンド**:
  ```bash
  # サービス状態確認
  sudo systemctl status dsns-timeline-bot-main
  
  # ログ確認（リアルタイム）
  sudo journalctl -u dsns-timeline-bot-main -f
  
  # サービス再起動
  sudo systemctl restart dsns-timeline-bot-main
  
  # サービス停止
  sudo systemctl stop dsns-timeline-bot-main
  
  # サービス開始
  sudo systemctl start dsns-timeline-bot-main
  
  # タイマー状態確認
  sudo systemctl list-timers dsns-bot-*
  
  # 全ログ確認
  sudo journalctl -u dsns-timeline-bot-main -n 100
  
  # エラーログのみ
  sudo journalctl -u dsns-timeline-bot-main -p err
  ```
- **設定ファイル**:
  - `/etc/systemd/system/dsns-timeline-bot-main.service`
  - `/etc/systemd/system/dsns-bot-data-update.service`
  - `/etc/systemd/system/dsns-bot-data-update.timer`
  - `/etc/systemd/system/dsns-bot-backup.service`
  - `/etc/systemd/system/dsns-bot-backup.timer`
- **結果**: 完全自動化達成
  - Raspberry Pi再起動時の自動起動
  - 24時間無人運用可能
  - エラー時の自動復旧
  - 統合ログ管理

### 2025-07-10: 大規模リファクタリング作業の完了
- **目的**: コードベースの品質向上、保守性改善、型安全性の確保、開発効率の向上
- **実装内容**:
  - **新しい定数ファイル (constants.py)**:
    - 全定数の一元管理（Visibility、MessageLimits、TimeFormats、CommandTypes等）
    - 型安全性の向上（Literal型による制約）
    - エラーメッセージの統一（ErrorMessages、SuccessMessages）
    - デフォルト値の集中管理（DefaultValues）
  - **新しい例外クラス (exceptions.py)**:
    - 階層化された例外クラス（DSNSBotError基底クラス）
    - 機能別例外（DataServiceError、BotClientError、CommandParseError等）
    - 詳細なエラー情報（エラーコンテキスト、ハンドラー情報）
    - 統一されたエラーハンドリングパターン
  - **新しい型定義 (dsnstypes.py)**:
    - TypedDictによる型安全な辞書定義（CommandDict、EventData等）
    - 複合型定義（DecadeStatistics、StatusInfo等）
    - Literal型による制約付き型（VisibilityType、CommandTypes等）
    - 型ヒントの完全化によるIDEサポート向上
  - **包括的テスト (test_refactoring_comprehensive.py)**:
    - 定数、例外、型定義の統合テスト
    - データサービス、データベース、ハンドラーの動作確認
    - エラーハンドリングワークフローの検証
    - 定数使用パターンのテスト
  - **統合テスト (test_refactoring_final.py)**:
    - 全機能の統合動作確認
    - リファクタリング完了の最終検証
    - 8つのテストカテゴリによる包括的検証
  - **ドキュメント (REFACTORING_DOCUMENTATION.md)**:
    - 新しい定数、例外、型定義の詳細説明
    - 使用例とベストプラクティス
    - テスト実行方法と結果解釈
    - 移行ガイドと注意事項
- **技術的改善**:
  - **型安全性の向上**: 全ファイルで型ヒントの完全化
  - **エラーハンドリングの統一**: 統一された例外処理パターン
  - **コードの一貫性**: 定数使用による一貫した値の使用
  - **保守性の向上**: モジュール化された設計
  - **開発効率の向上**: IDEサポートとドキュメントの充実
- **修正されたファイル**:
  - **ハンドラーファイル**: 全ハンドラーで新しい定数、例外、型定義を使用
  - **command_router.py**: 型エラーの修正、新しい定数の使用
  - **data_service.py**: 例外処理の統一、型ヒントの追加
  - **database.py**: 型安全性の向上
  - **bot_client.py**: エラーハンドリングの改善
- **テスト結果**:
  - **総テスト数**: 35個のテストケース
  - **成功率**: 100% (35/35)
  - **エラー数**: 0件
  - **警告数**: 0件
- **改善効果**:
  - **コード品質**: 型安全性と可読性の大幅向上
  - **保守性**: 統一されたエラーハンドリングと定数管理
  - **拡張性**: 明確な型定義による新機能追加の容易性
  - **開発効率**: IDEサポートとドキュメントの充実
  - **バグ削減**: 型チェックによる早期エラー検出
- **結果**: プロダクションレベルのコード品質を達成し、今後の開発・保守が大幅に効率化

### 2025-07-10: プロジェクト構造の大規模整理・改善
- **目的**: プロジェクトの可読性向上、保守性改善、開発効率の向上、新規開発者の理解しやすさの確保
- **実施内容**:
  - **ディレクトリ構造の整理**:
    - **`tests/`**: 全テストファイルを専用ディレクトリに移動（18ファイル）
      - リファクタリング関連テスト（4ファイル）
      - 機能別テスト（14ファイル）
    - **`utils/`**: ユーティリティファイルを専用ディレクトリに移動（3ファイル）
      - データベース関連ユーティリティ
      - デバッグ・修正ツール
    - **`docs/`**: ドキュメントファイルを専用ディレクトリに移動（4ファイル）
      - プロジェクト概要、開発ガイド、リファクタリング詳細、MiPA運用ガイド
  - **不要ファイルの削除**:
    - **`timeline.db`**: ルートの空ファイル（重複）
    - **`test_refactoring.log`**: 空のログファイル
    - **`handlers/date_request.py`**: 未使用の空ファイル
    - **`venv/`**: 古い仮想環境ディレクトリ
  - **新規ファイルの追加**:
    - **`README.md`**: プロジェクト概要・セットアップガイド
      - 機能説明、プロジェクト構造、セットアップ手順
      - 運用方法、開発ワークフロー、対応コマンド
      - 関連リンク、ライセンス情報
    - **`.env.example`**: 環境変数テンプレート
      - Misskey接続設定、データソース設定、データベース設定
      - 投稿設定、ログ設定、HTTP設定、開発設定
  - **テスト環境の整備**:
    - **`pytest.ini`**: pytest設定ファイル
      - 非同期テスト自動検出（asyncio_mode = auto）
      - 警告抑制、詳細出力設定
      - テストマーカー定義（slow、integration、unit）
    - **`requirements.txt`**: テスト用依存関係の追加
      - pytest==8.4.1（テストフレームワーク）
      - pytest-asyncio==1.0.0（非同期テスト対応）
- **改善効果**:
  - **可読性の向上**:
    - ルートディレクトリがすっきり（約30ファイル → 約15ファイル）
    - 機能別ディレクトリによる明確な分類
    - 新規開発者が理解しやすい構造
  - **保守性の向上**:
    - テストファイルの一元管理
    - ユーティリティの集約
    - ドキュメントの整理
  - **開発効率の向上**:
    - ファイル検索が容易
    - 機能別の開発・テストが可能
    - 新機能追加時の配置が明確
  - **運用性の向上**:
    - README.mdによる迅速なセットアップ
    - .env.exampleによる環境構築の簡素化
    - ドキュメントの体系化
- **整理結果**:
  - **削除ファイル**: 4個（不要ファイル）
  - **移動ファイル**: 25個（テスト18個、ユーティリティ3個、ドキュメント4個）
  - **新規ファイル**: 2個（README.md、.env.example）
  - **ディレクトリ**: 3個新規作成（tests/、utils/、docs/）
- **テスト実行方法**:
  ```bash
  # 全テスト実行
  PYTHONPATH=. python -m pytest tests/
  
  # 特定テスト実行
  PYTHONPATH=. python -m pytest tests/test_refactoring_final.py
  
  # リファクタリング統合テスト
  PYTHONPATH=. python tests/test_refactoring_final.py
  ```
- **今後の開発ワークフロー**:
  ```bash
  # 1. コード修正
  vim main.py
  
  # 2. テスト実行
  PYTHONPATH=. python -m pytest tests/
  
  # 3. サービス再起動
  sudo systemctl restart dsns-timeline-bot-main
  
  # 4. デバッグが必要な場合
  sudo systemctl stop dsns-timeline-bot-main
  python main.py  # 手動実行
  ```
- **結果**: プロジェクトの保守性、可読性、開発効率が大幅に向上し、新規開発者も含めて誰でも理解しやすい構造を実現

### 新機能: カテゴリ別フィルタ・複合検索
- **カテゴリ別フィルタ**: `カテゴリ:fire` でfireカテゴリのイベント一覧
- **カテゴリ一覧**: `カテゴリ一覧` で利用可能なカテゴリ一覧を表示
- **複合検索**: `検索 SNS カテゴリ:fire` でSNSかつfireカテゴリのイベント

### 新機能: カテゴリ複合フィルタ・複合検索
- **カテゴリ複合フィルタ**: `カテゴリ:d-sns,tech -meme` でd-snsかつtechだがmeme以外のイベント
- **カテゴリ一覧**: `カテゴリ一覧` で利用可能なカテゴリ一覧を表示
- **複合検索**: `検索 SNS カテゴリ:d-sns,tech -incident` でSNSキーワードかつd-sns・techだがincident以外
- **年代＋カテゴリ**: `2000年代 カテゴリ:web,tech` で2000年代のweb・techカテゴリのイベント

**カテゴリ設計思想**: 元のHTMLではカテゴリは単純なフィルタリングではなく、複数のカテゴリを組み合わせた高度な検索・分析のための設計となっている。

### 2025-07-11: 年代機能の拡張（1920年代～1980年代対応）
- **目的**: データベースに存在する全年代（1920年代～2020年代）への完全対応
- **実装内容**:
  - command_router.py, summary_manager.py, database.pyの年代判定・分布ロジックを1920年代～1980年代まで拡張
  - data/summaries/配下に1920s.md～1980s.mdの概要ファイルを新規追加
  - テスト（test_decade_functionality.py）に1920年代～1980年代の自動テストを追加
- **効果**:
  - すべての年代で統計・概要・代表イベントが取得可能に
  - データベースの全範囲をカバー
  - テストも全年代で自動化